<!DOCTYPE html>
<html>

<head>
    <title>API Connection Test - UbuntuCap</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            line-height: 1.6;
        }

        .test {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: 1px solid #007bff;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        input,
        select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            min-height: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>UbuntuCap Backend Connection Test</h1>

    <div class="test" id="csrf-test">
        <h3>1. Test CSRF Token</h3>
        <button onclick="testCSRF()">Test CSRF</button>
        <div class="test-result" id="csrf-result"></div>
    </div>

    <div class="test" id="login-test">
        <h3>2. Test Login (Use Existing User)</h3>
        <div>
            <label>Phone Number:</label>
            <input type="text" id="phone" placeholder="+254712345678" value="+254712345678">
        </div>
        <div>
            <label>Password:</label>
            <input type="password" id="password" placeholder="Password" value="testpass123">
        </div>
        <button onclick="testLogin()">Test Login</button>
        <div class="test-result" id="login-result"></div>
    </div>

    <div class="test" id="register-test">
        <h3>3. Test Registration (New User)</h3>
        <div>
            <label>Phone Number:</label>
            <input type="text" id="reg-phone" placeholder="+254700000000" value="+254700000002">
            <small style="color: #666;">Change last digits for new user</small>
        </div>
        <div>
            <label>First Name:</label>
            <input type="text" id="reg-first-name" placeholder="John" value="Test">
        </div>
        <div>
            <label>Last Name:</label>
            <input type="text" id="reg-last-name" placeholder="Doe" value="User">
        </div>
        <div>
            <label>Email:</label>
            <input type="email" id="reg-email" placeholder="john@example.com" value="test2@example.com">
        </div>
        <div>
            <label>ID Number:</label>
            <input type="text" id="reg-id" placeholder="12345678" value="12345679">
        </div>
        <div>
            <label>Password:</label>
            <input type="password" id="reg-password" placeholder="Password" value="testpass123">
        </div>
        <div>
            <label>Confirm Password:</label>
            <input type="password" id="reg-password-confirm" placeholder="Confirm Password" value="testpass123">
        </div>
        <div>
            <label>Registration Channel:</label>
            <select id="reg-channel">
                <option value="APP">APP</option>
                <option value="USSD">USSD</option>
            </select>
        </div>
        <button onclick="testRegistration()">Test Registration</button>
        <div class="test-result" id="register-result"></div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';

        async function testCSRF() {
            const result = document.getElementById('csrf-result');
            try {
                result.innerHTML = 'Testing CSRF token endpoint...';
                const response = await fetch('http://127.0.0.1:8000/csrf-token/', {
                    credentials: 'include'
                });
                const data = await response.json();
                result.innerHTML = `‚úÖ SUCCESS:\n${JSON.stringify(data, null, 2)}`;
                result.parentElement.className = 'test success';
            } catch (error) {
                result.innerHTML = `‚ùå ERROR: ${error.message}`;
                result.parentElement.className = 'test error';
            }
        }

        async function testLogin() {
            const result = document.getElementById('login-result');
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;

            try {
                result.innerHTML = 'Attempting login with POST...';

                // Get CSRF token first
                const csrfResponse = await fetch('http://127.0.0.1:8000/csrf-token/', {
                    credentials: 'include'
                });
                const csrfData = await csrfResponse.json();
                const csrfToken = csrfData.csrfToken;

                console.log('üîê Login attempt:', { phone, password: '***', csrfToken });

                const response = await fetch(API_BASE + '/users/login/', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        phone_number: phone,
                        password: password
                    })
                });

                console.log('üì° Login response status:', response.status);

                const data = await response.json();
                console.log('üì° Login response data:', data);

                if (response.ok && data.success) {
                    result.innerHTML = `‚úÖ LOGIN SUCCESS!\n\nUser: ${data.user.first_name} ${data.user.last_name}\nPhone: ${data.user.phone_number}\nVerified: ${data.user.is_verified}\n\nFull response:\n${JSON.stringify(data, null, 2)}`;
                    result.parentElement.className = 'test success';

                    // Store user data for protected endpoints
                    window.userData = data.user;
                } else {
                    result.innerHTML = `‚ùå LOGIN FAILED:\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`;
                    result.parentElement.className = 'test error';
                }
            } catch (error) {
                result.innerHTML = `‚ùå NETWORK ERROR: ${error.message}\n\nMake sure:\n1. Django server is running\n2. Check browser console for details`;
                result.parentElement.className = 'test error';
                console.error('Login error:', error);
            }
        }

        async function testRegistration() {
            const result = document.getElementById('register-result');

            const registrationChannel = document.getElementById('reg-channel').value;

            const formData = {
                phone_number: document.getElementById('reg-phone').value,
                first_name: document.getElementById('reg-first-name').value,
                last_name: document.getElementById('reg-last-name').value,
                email: document.getElementById('reg-email').value,
                id_number: document.getElementById('reg-id').value,
                password: document.getElementById('reg-password').value,
                password_confirm: document.getElementById('reg-password-confirm').value,
                registration_channel: registrationChannel
            };

            // Validate passwords match
            if (formData.password !== formData.password_confirm) {
                result.innerHTML = '‚ùå ERROR: Passwords do not match!';
                result.parentElement.className = 'test error';
                return;
            }

            try {
                result.innerHTML = `Attempting registration with channel: ${registrationChannel}...`;

                // Get CSRF token
                const csrfResponse = await fetch('http://127.0.0.1:8000/csrf-token/', {
                    credentials: 'include'
                });
                const csrfData = await csrfResponse.json();
                const csrfToken = csrfData.csrfToken;

                console.log('üë§ Registration attempt:', { ...formData, password: '***', password_confirm: '***' });

                const response = await fetch(API_BASE + '/users/register/', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(formData)
                });

                console.log('üì° Registration response status:', response.status);

                const data = await response.json();
                console.log('üì° Registration response data:', data);

                if (response.ok && data.success) {
                    result.innerHTML = `‚úÖ REGISTRATION SUCCESS!\n\nUser ID: ${data.user_id}\nPhone: ${data.phone_number}\nChannel: ${registrationChannel}\nVerification Code: ${data.verification_code || 'Check server console'}\n\nFull response:\n${JSON.stringify(data, null, 2)}`;
                    result.parentElement.className = 'test success';
                } else {
                    result.innerHTML = `‚ùå REGISTRATION FAILED:\nStatus: ${response.status}\nChannel Used: ${registrationChannel}\nResponse: ${JSON.stringify(data, null, 2)}`;
                    result.parentElement.className = 'test error';
                }
            } catch (error) {
                result.innerHTML = `‚ùå NETWORK ERROR: ${error.message}`;
                result.parentElement.className = 'test error';
                console.error('Registration error:', error);
            }
        }

        // Auto-generate unique phone number
        function generateUniquePhone() {
            const timestamp = Date.now().toString().slice(-4);
            document.getElementById('reg-phone').value = `+2547000${timestamp}`;
            document.getElementById('reg-email').value = `test${timestamp}@example.com`;
            document.getElementById('reg-id').value = `12345${timestamp}`;
        }

        // Call on page load
        window.onload = generateUniquePhone;
    </script>
</body>

</html>